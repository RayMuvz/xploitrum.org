name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DROPLET_IP }}
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          cd /home/xploitrum.org
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling from GitHub..."
          git pull origin main
          
          # Update backend
          echo "ğŸ”§ Updating backend..."
          cd backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          
          # Update frontend
          echo "ğŸ¨ Updating frontend..."
          cd ../frontend
          npm install --silent
          npm run build
          
          # Restart services
          echo "ğŸ”„ Restarting services..."
          sudo systemctl restart xploitrum-backend
          sudo systemctl restart xploitrum-frontend
          sudo systemctl reload nginx
          
          # Check status
          echo "âœ… Deployment complete!"
          echo "Backend: $(sudo systemctl is-active xploitrum-backend)"
          echo "Frontend: $(sudo systemctl is-active xploitrum-frontend)"
          
    - name: âœ… Deployment Status
      if: success()
      run: echo "ğŸ‰ Successfully deployed to production!"
      
    - name: âŒ Deployment Failed
      if: failure()
      run: echo "âŒ Deployment failed. Check logs on server."

