name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    
    steps:
    - name: Create deploy key
      run: |
        printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ./deploy_key
        chmod 600 ./deploy_key
      
    - name: üöÄ Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DROPLET_IP }}
        username: root
        key_path: ./deploy_key
        port: 22
        script_stop: true
        script: |
          set -e
          echo "üöÄ Starting deployment..."
          
          # Backup
          mkdir -p /root/backups/pre-deployment-$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR=/root/backups/pre-deployment-$(date +%Y%m%d_%H%M%S)
          sudo -u postgres pg_dump xploitrum > $BACKUP_DIR/database_backup.sql || echo "‚ö†Ô∏è Could not backup database"
          cp /home/xploitrum.org/backend/.env $BACKUP_DIR/.env || echo "‚ö†Ô∏è Could not backup .env"
          
          # Update
          cd /home/xploitrum.org
          git pull origin main
          
          # Backend
          cd backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet --upgrade
          python add_must_change_password_column.py || echo "‚ö†Ô∏è Column may already exist"
          python create_member_requests_table.py || echo "‚ö†Ô∏è Table may already exist"
          sudo systemctl restart xploitrum-backend
          sleep 3
          
          # Frontend
          cd ../frontend
          npm install --silent
          npm run build
          sudo systemctl restart xploitrum-frontend
          sleep 3
          
          # Reload
          sudo systemctl reload nginx
          
          echo "‚úÖ Deployment complete!"
